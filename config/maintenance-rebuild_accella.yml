sql:
- name: TRUNCATE TABLE coagis.accella_parcel_attr_cache 
  text: TRUNCATE TABLE coagis.accella_parcel_attr_cache ;
  values:
- name: insert PINNUMBER
  text: INSERT INTO coagis.accella_parcel_attr_cache(SELECT 1::int as source_seq_nbr_PATT, "1"::varchar(25) as L1_parcel_nbr_PATT, 'PINNUMBER'::Varchar(30) as L1_attrib_temp_name, 'PINNUMBER'::Varchar(30)as L1_attrib_name, (loc.parcel_id || civ.pinext)::varchar(200)as L1_attrib_value  FROM  coagis.coa_muniscpfinput as m LEFT JOIN coagis.bc_civicaddress_table civ ON civ.civicaddress_id::varchar(25) = m."1" LEFT JOIN coagis.bc_location_table as loc ON loc.location_id = civ.location_id LEFT JOIN coagis.bc_property as prop ON loc.parcel_id || civ.pinext::varchar(50) = prop.pinnum WHERE "31" <> 'Buncombe County' );
  values:
- name: insert JURISDICTION
  text: INSERT INTO coagis.accella_parcel_attr_cache( SELECT 1::int as source_seq_nbr_PATT, "1"::varchar(25) as L1_parcel_nbr_PATT, 'JURISDICTION'::Varchar(30) as L1_attrib_temp_name, 'JURISDICTION'::Varchar(30)as L1_attrib_name, "31"::varchar(200)as L1_attrib_value FROM  coagis.coa_muniscpfinput as m LEFT JOIN coagis.bc_civicaddress_table civ ON civ.civicaddress_id::varchar(25) = m."1" LEFT JOIN coagis.bc_location_table as loc ON loc.location_id = civ.location_id LEFT JOIN coagis.bc_property as prop ON loc.parcel_id || civ.pinext::varchar(50) = prop.pinnum WHERE "31" <> 'Buncombe County');  
  values:
- name: insert ZONING DISTRICT 
  text: INSERT INTO coagis.accella_parcel_attr_cache( SELECT 1::int as source_seq_nbr_PATT, "1"::varchar(25) as L1_parcel_nbr_PATT, 'ZONING DISTRICT'::Varchar(30) as L1_attrib_temp_name, 'ZONING DISTRICT'::Varchar(30)as L1_attrib_name, (CASE WHEN length( coalesce ((SELECT coagis.textcat_all(districts || ',') FROM coagis.coa_districts_zoning b WHERE st_intersects(b.shape,prop.shape)),'No Zoning'))>0 then coalesce ((SELECT coagis.textcat_all(districts || ',') FROM coagis.coa_districts_zoning b WHERE st_intersects(b.shape,prop.shape)),'No Zoning') else 'No Zoning' END) ::varchar(200)   as L1_attrib_value FROM  coagis.coa_muniscpfinput as m LEFT JOIN coagis.bc_civicaddress_table civ ON civ.civicaddress_id::varchar(25) = m."1" LEFT JOIN coagis.bc_location_table as loc ON loc.location_id = civ.location_id LEFT JOIN coagis.bc_property_buffer_1_foot_less as prop ON loc.parcel_id || civ.pinext::varchar(50) = prop.pinnum WHERE "31" <> 'Buncombe County'); 
  values:
- name: insert RIVER DISTRICT
  text: INSERT INTO coagis.accella_parcel_attr_cache( SELECT 1::int as source_seq_nbr_PATT, "1"::varchar(25) as L1_parcel_nbr_PATT, 'RIVER DISTRICT'::Varchar(30) as L1_attrib_temp_name, 'RIVER DISTRICT'::Varchar(30)as L1_attrib_name, (CASE WHEN strpos(coalesce ((SELECT coagis.textcat_all((case when districts = 'RIVER' then 'Yes' else 'No' end)|| ',')::varchar(250) FROM coagis.coa_districts_zoning b WHERE st_intersects(b.shape,prop.shape) ),'No'),'Yes')>0 then 'Yes' else 'No' end)::varchar(200)   as L1_attrib_value FROM  coagis.coa_muniscpfinput as m LEFT JOIN coagis.bc_civicaddress_table civ ON civ.civicaddress_id::varchar(25) = m."1" LEFT JOIN coagis.bc_location_table as loc ON loc.location_id = civ.location_id LEFT JOIN coagis.bc_property as prop ON loc.parcel_id || civ.pinext::varchar(50) = prop.pinnum WHERE "31" <> 'Buncombe County');
  values:
- name: insert DTDR OVERLAY 
  text: INSERT INTO coagis.accella_parcel_attr_cache(SELECT 1::int as source_seq_nbr_PATT, "1"::varchar(25) as L1_parcel_nbr_PATT, 'DTDR OVERLAY'::Varchar(30) as L1_attrib_temp_name, 'DTDR OVERLAY'::Varchar(30)as L1_attrib_name, (CASE WHEN strpos(coalesce ((SELECT coagis.textcat_all((case when districts = 'CBD' and acreage > 50 then 'Yes' else 'No' end)|| ',')::varchar(250) FROM coagis.coa_districts_zoning b WHERE st_intersects(b.shape,prop.shape) ),'No'),'Yes')>0 then 'Yes' else 'No' end)::varchar(200)   as L1_attrib_value FROM  coagis.coa_muniscpfinput as m LEFT JOIN coagis.bc_civicaddress_table civ ON civ.civicaddress_id::varchar(25) = m."1" LEFT JOIN coagis.bc_location_table as loc ON loc.location_id = civ.location_id LEFT JOIN coagis.bc_property as prop ON loc.parcel_id || civ.pinext::varchar(50) = prop.pinnum WHERE "31" <> 'Buncombe County')  ;
  values:
- name: insert HRC OVERLAY
  text: INSERT INTO coagis.accella_parcel_attr_cache( SELECT 1::int as source_seq_nbr_PATT, "1"::varchar(25) as L1_parcel_nbr_PATT, 'HRC OVERLAY'::Varchar(30) as L1_attrib_temp_name, 'HRC OVERLAY'::Varchar(30)as L1_attrib_name, (CASE WHEN strpos(coalesce ((SELECT coagis.textcat_all( (case when length(name)> 0 then 'Yes' else 'No' end) || ',')::varchar(250) FROM coagis.coa_overlay_historic_districts_view b WHERE st_intersects(b.shape,prop.shape)  ),'No'),'Yes')>0 then 'Yes' else 'No' end)::varchar(200)   as L1_attrib_value FROM  coagis.coa_muniscpfinput as m LEFT JOIN coagis.bc_civicaddress_table civ ON civ.civicaddress_id::varchar(25) = m."1" LEFT JOIN coagis.bc_location_table as loc ON loc.location_id = civ.location_id LEFT JOIN coagis.bc_property as prop ON loc.parcel_id || civ.pinext::varchar(50) = prop.pinnum WHERE "31" <> 'Buncombe County') ;
  values:
- name: insert FLOOD PLAIN
  text: INSERT INTO coagis.accella_parcel_attr_cache( SELECT 1::int as source_seq_nbr_PATT, "1"::varchar(25) as L1_parcel_nbr_PATT, 'FLOOD PLAIN'::Varchar(30) as L1_attrib_temp_name, 'FLOOD PLAIN'::Varchar(30)as L1_attrib_name, (CASE WHEN strpos(coalesce ((SELECT coagis.textcat_all((case when zone_lid = '1001' then 'Yes' else 'X (Out or 500 Year Flood)' end) || ',')::varchar(250) FROM coagis.ncfmp_sfha_2007_view b WHERE st_intersects(b.shape,prop.shape) ),'X (Out or 500 Year Flood)')::varchar(200) ,'Yes')>0 then 'Yes' else 'X (Out or 500 Year Flood)' end)::varchar(200)  as L1_attrib_value FROM  coagis.coa_muniscpfinput as m LEFT JOIN coagis.bc_civicaddress_table civ ON civ.civicaddress_id::varchar(25) = m."1" LEFT JOIN coagis.bc_location_table as loc ON loc.location_id = civ.location_id LEFT JOIN coagis.bc_property as prop ON loc.parcel_id || civ.pinext::varchar(50) = prop.pinnum WHERE "31" <> 'Buncombe County');
  values:
- name: insert FIRE DISTRICT
  text: INSERT INTO coagis.accella_parcel_attr_cache( SELECT 1::int as source_seq_nbr_PATT, "1"::varchar(25) as L1_parcel_nbr_PATT, 'FIRE DISTRICT'::Varchar(30) as L1_attrib_temp_name, 'FIRE DISTRICT'::Varchar(30)as L1_attrib_name, (CASE WHEN length( coalesce ((SELECT  coagis.textcat_all("name" || ',') FROM coagis.coa_districts_fire b WHERE st_intersects(b.shape,prop.shape) ),'None'))>0 then coalesce ((SELECT  coagis.textcat_all("name" || ',') FROM coagis.coa_districts_fire b WHERE st_intersects(b.shape,prop.shape) ),'None') else 'None' END)::varchar(200)   as L1_attrib_value FROM  coagis.coa_muniscpfinput as m LEFT JOIN coagis.bc_civicaddress_table civ ON civ.civicaddress_id::varchar(25) = m."1" LEFT JOIN coagis.bc_location_table as loc ON loc.location_id = civ.location_id LEFT JOIN coagis.bc_property as prop ON loc.parcel_id || civ.pinext::varchar(50) = prop.pinnum WHERE "31" <> 'Buncombe County' );
  values:
- name: insert LANDMARK 
  text: INSERT INTO coagis.accella_parcel_attr_cache( SELECT 1::int as source_seq_nbr_PATT, "1"::varchar(25) as L1_parcel_nbr_PATT, 'LANDMARK'::Varchar(30) as L1_attrib_temp_name, 'LANDMARK'::Varchar(30)as L1_attrib_name, (CASE WHEN strpos(coalesce ((SELECT coagis.textcat_all( (case when length(ll_name)> 0 then 'Yes' else 'No' end) || ',')::varchar(250) FROM coagis.coa_local_historic_landmarks b WHERE ST_Contains (prop.shape,b.shape)  ),'No'),'Yes')>0 then 'Yes' else 'No' end)::varchar(200)   as L1_attrib_value FROM  coagis.coa_muniscpfinput as m LEFT JOIN coagis.bc_civicaddress_table civ ON civ.civicaddress_id::varchar(25) = m."1" LEFT JOIN coagis.bc_location_table as loc ON loc.location_id = civ.location_id LEFT JOIN coagis.bc_property as prop ON loc.parcel_id || civ.pinext::varchar(50) = prop.pinnum WHERE "31" <> 'Buncombe County' );
  values:
- name: insert AQUATIC BUFFER
  text: INSERT INTO coagis.accella_parcel_attr_cache( SELECT 1::int as source_seq_nbr_PATT, "1"::varchar(25) as L1_parcel_nbr_PATT, 'AQUATIC BUFFER'::Varchar(30) as L1_attrib_temp_name, 'AQUATIC BUFFER'::Varchar(30)as L1_attrib_name, (CASE WHEN strpos(coalesce ((SELECT coagis.textcat_all((case when buffertype is not null then 'Yes' else 'No' end)|| ',')::varchar(250) FROM coagis.coa_aquatic_buffers b WHERE st_intersects(b.shape,prop.shape) ),'No'),'Yes')>0 then 'Yes' else 'No' end)::varchar(200)   as L1_attrib_value FROM  coagis.coa_muniscpfinput as m LEFT JOIN coagis.bc_civicaddress_table civ ON civ.civicaddress_id::varchar(25) = m."1" LEFT JOIN coagis.bc_location_table as loc ON loc.location_id = civ.location_id LEFT JOIN coagis.bc_property as prop ON loc.parcel_id || civ.pinext::varchar(50) = prop.pinnum WHERE "31" <> 'Buncombe County' );
  values:
- name: insert INSPECTION GROUP
  text:  INSERT INTO coagis.accella_parcel_attr_cache( SELECT 1::int as source_seq_nbr_PATT, "1"::varchar(25) as L1_parcel_nbr_PATT, 'INSPECTION GROUP'::Varchar(30) as L1_attrib_temp_name, 'INSPECTION GROUP'::Varchar(30)as L1_attrib_name, (CASE WHEN length( coalesce ((SELECT  coagis.textcat_all("accela_name" || ',') FROM coagis.coa_districts_development_review_and_inspection b WHERE st_intersects(b.shape,prop.shape) ),'None'))>0 then coalesce ((SELECT  coagis.textcat_all("accela_name" || ',') FROM coagis.coa_districts_development_review_and_inspection b WHERE st_intersects(b.shape,prop.shape) ),'None') else 'None' END)::varchar(200)   as L1_attrib_value  FROM  coagis.coa_muniscpfinput as m LEFT JOIN coagis.bc_civicaddress_table civ ON civ.civicaddress_id::varchar(25) = m."1" LEFT JOIN coagis.bc_location_table as loc ON loc.location_id = civ.location_id LEFT JOIN coagis.bc_property as prop ON loc.parcel_id || civ.pinext::varchar(50) = prop.pinnum WHERE "31" <> 'Buncombe County' ) ;
  values:
- name: insert BUILDING VALUE
  text:  INSERT INTO coagis.accella_parcel_attr_cache( SELECT 1::int as source_seq_nbr_PATT, "1"::varchar(25) as L1_parcel_nbr_PATT,   'BUILDING VALUE'::Varchar(30) as L1_attrib_temp_name, 'BUILDING VALUE'::Varchar(30)as L1_attrib_name,    (prop.buildingvalue::integer)::varchar(200) as L1_attrib_value FROM  coagis.coa_muniscpfinput as m LEFT JOIN coagis.bc_civicaddress_table civ ON civ.civicaddress_id::varchar(25) = m."1" LEFT JOIN coagis.bc_location_table as loc ON loc.location_id = civ.location_id LEFT JOIN coagis.bc_property as prop ON loc.parcel_id || civ.pinext::varchar(50) = prop.pinnum WHERE "31" <> 'Buncombe County' );
  values:
- name: insert INNOVATION DISTRICT
  text: INSERT INTO coagis.accella_parcel_attr_cache( SELECT 1::int as source_seq_nbr_PATT, "1"::varchar(25) as L1_parcel_nbr_PATT, 'INNOVATION DISTRICT'::Varchar(30) as L1_attrib_temp_name, 'INNOVATION DISTRICT'::Varchar(30)as L1_attrib_name, (CASE WHEN length( coalesce ((SELECT  coagis.textcat_all("name" || ',') FROM coagis.coa_innovation_districts b WHERE st_intersects(b.shape,prop.shape) ),'None'))>0 then coalesce ((SELECT  coagis.textcat_all("name" || ',') FROM coagis.coa_innovation_districts b WHERE st_intersects(b.shape,prop.shape) ),'None') else 'None' END)::varchar(200)   as L1_attrib_value FROM  coagis.coa_muniscpfinput as m LEFT JOIN coagis.bc_civicaddress_table civ ON civ.civicaddress_id::varchar(25) = m."1" LEFT JOIN coagis.bc_location_table as loc ON loc.location_id = civ.location_id LEFT JOIN coagis.bc_property as prop ON loc.parcel_id || civ.pinext::varchar(50) = prop.pinnum WHERE "31" <> 'Buncombe County') ;
  values:
- name: update trailing comma in INSPECTION GROUP 
  text: update coagis.accella_parcel_attr_cache SET  L1_attrib_value  = substring(L1_attrib_value,0,length(L1_attrib_value)) WHERE L1_attrib_temp_name = 'INSPECTION GROUP'  and substring(L1_attrib_value,length(L1_attrib_value),length(L1_attrib_value)) = ',';
  values:
- name: remove null address ids
  text: delete from coagis.accella_parcel_attr_cache where l1_parcel_nbr_patt is null;
  values:
- name: vaccum accella_parcel_attr_cache
  text: VACUUM FULL ANALYZE coagis.accella_parcel_attr_cache;
  values:
